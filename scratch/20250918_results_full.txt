Ablation summary [val]
Mode                N      Acc       F1    ROC-AUC     PR-AUC
------------------------------------------------------
cond+prompt     10000   0.9392   0.8956     0.9827     0.9661
cond_only       10000   0.7716   0.5388     0.7479     0.5885
prompt_only     10000   0.9265   0.8730     0.9763     0.9540

Δ vs cond+prompt:
- cond_only     ΔAcc=-0.1676  ΔF1=-0.3569  ΔROC-AUC=-0.2348  ΔPR-AUC=-0.3776
- prompt_only   ΔAcc=-0.0127  ΔF1=-0.0226  ΔROC-AUC=-0.0064  ΔPR-AUC=-0.0120



In [6]: res = llm_eval.run_all(seq_ds=datasets, sample_rationales=10, out_dir="artifacts/qwen3/")
[INFO] Eval: D_cond=2016 (eff=1280 go=256 prot=480)
Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:04<00:00,  1.65s/it]
[LOAD] Loading adapter via PeftModel.from_pretrained: artifacts/qwen3/adapter
[LOAD] Projector check OK: hidden=2560 k=8 D_cond=2016
[LOAD] Projector loaded. dtype=torch.float16 device=cuda:0
Scoring [val]: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 491/491 [37:50<00:00,  4.62s/batch]

VAL metrics:
{'n': 31384, 'accuracy': 0.962018863114963, 'precision': 0.918804549061095, 'recall': 0.9231995748073346, 'f1': 0.9209968186638389, 'auc_roc': 0.9904281554294123, 'auc_pr': 0.9767990781492394}
Confusion: [[23244, 614], [578, 6948]]
Saved VAL predictions to: artifacts/qwen3/val_scored.feather
[INFO] Eval: D_cond=2016 (eff=1280 go=256 prot=480)
Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3/3 [00:04<00:00,  1.59s/it]
[LOAD] Loading adapter via PeftModel.from_pretrained: artifacts/qwen3/adapter
[LOAD] Projector check OK: hidden=2560 k=8 D_cond=2016
[LOAD] Projector loaded. dtype=torch.float16 device=cuda:0
Scoring [test]: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 508/508 [39:22<00:00,  4.65s/batch]

TEST metrics:
{'n': 32468, 'accuracy': 0.9546322532955526, 'precision': 0.910966810966811, 'recall': 0.8805970149253731, 'f1': 0.8955245052840627, 'auc_roc': 0.9846876964560075, 'auc_pr': 0.9599740995411866}
Confusion: [[24682, 617], [856, 6313]]
Saved TEST predictions to: artifacts/qwen3/test_scored.feather



In [7]: res
Out[7]: 
{'val': {'split': 'val',
  'n': 31384,
  'accuracy': 0.962018863114963,
  'precision': 0.918804549061095,
  'recall': 0.9231995748073346,
  'f1': 0.9209968186638389,
  'auc_roc': 0.9904281554294123,
  'auc_pr': 0.9767990781492394,
  'confusion_matrix': [[23244, 614], [578, 6948]],
  'report': '              precision    recall  f1-score   support\n\n      Benign      0.976     0.974     0.975     23858\n  Pathogenic      0.919     0.923     0.921      7526\n\n    accuracy                          0.962     31384\n   macro avg      0.947     0.949     0.948     31384\nweighted avg      0.962     0.962     0.962     31384\n',
  'examples': [{'idx': 0,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0072290655225515366,
     'Pathogenic': 0.9927709102630615}},
   {'idx': 1,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0011172962840646505,
     'Pathogenic': 0.9988827109336853}},
   {'idx': 2,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.003482047701254487,
     'Pathogenic': 0.9965180158615112}},
   {'idx': 3,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0010495836613699794,
     'Pathogenic': 0.9989504218101501}},
   {'idx': 4,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.005478078965097666,
     'Pathogenic': 0.994521975517273}},
   {'idx': 5,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0018420740962028503,
     'Pathogenic': 0.9981579780578613}},
   {'idx': 6,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0016256379894912243,
     'Pathogenic': 0.9983744025230408}},
   {'idx': 7,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.6892010569572449, 'Pathogenic': 0.3107989430427551}},
   {'idx': 8,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.4073333740234375, 'Pathogenic': 0.5926665663719177}},
   {'idx': 9,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0008302819333039224,
     'Pathogenic': 0.9991697072982788}}],
  'predictions_path': 'artifacts/qwen3/val_scored.feather',
  'rationales': [{'idx': 26688,
    'pred_label': 'Benign',
    'rationale': 'this variant is located in an intron and does not affect the coding sequence or splice regions, it is unlikely to impact gene function.'},
   {'idx': 25523,
    'pred_label': 'Benign',
    'rationale': 'this variant affects a downstream gene (Pathogen: PKD2) rather than the gene itself, and is an upstream modifier with no effect on gene expression, it is likely to have no significant impact on the pathway.'},
   {'idx': 19985, 'pred_label': 'Benign', 'rationale': ''},
   {'idx': 16037,
    'pred_label': 'Benign',
    'rationale': 'this variant is synonymous (same amino acid and codon usage), it has no impact on the protein sequence or structure, so it is clinically neutral.'},
   {'idx': 8465,
    'pred_label': 'Benign',
    'rationale': 'the variant is synonymous and does not alter the amino acid sequence, the effect on the protein is neutral.'},
   {'idx': 1285,
    'pred_label': 'Pathogenic',
    'rationale': 'the variant is a frameshift variant with deletion of 4 bases resulting in premature stop codon, it severely disrupts the reading frame and causes early termination.'},
   {'idx': 518,
    'pred_label': 'Benign',
    'rationale': 'the variant is missense, not synonymous, and no severe consequence impact is given (no severe phenotype), we can classify it as Benogenic.'},
   {'idx': 9659,
    'pred_label': 'Benign',
    'rationale': 'this variant is synonymous, it does not alter the amino acids or the protein sequence, and therefore has no functional consequence.'},
   {'idx': 5500,
    'pred_label': 'Benign',
    'rationale': 'splice polypyrimidine tract variants are generally not impact-based and are located in intron regions, the variant is unlikely to affect gene function.'},
   {'idx': 2361,
    'pred_label': 'Pathogenic',
    'rationale': 'this variant creates a premature stop codon, resulting in a truncated protein product, the consequence is severe and disrupts normal function.'}]},
 'test': {'split': 'test',
  'n': 32468,
  'accuracy': 0.9546322532955526,
  'precision': 0.910966810966811,
  'recall': 0.8805970149253731,
  'f1': 0.8955245052840627,
  'auc_roc': 0.9846876964560075,
  'auc_pr': 0.9599740995411866,
  'confusion_matrix': [[24682, 617], [856, 6313]],
  'report': '              precision    recall  f1-score   support\n\n      Benign      0.966     0.976     0.971     25299\n  Pathogenic      0.911     0.881     0.896      7169\n\n    accuracy                          0.955     32468\n   macro avg      0.939     0.928     0.933     32468\nweighted avg      0.954     0.955     0.954     32468\n',
  'examples': [{'idx': 0,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0034820139408111572,
     'Pathogenic': 0.9965180158615112}},
   {'idx': 1,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.013828514143824577,
     'Pathogenic': 0.9861714839935303}},
   {'idx': 2,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 4.6841163566568866e-05,
     'Pathogenic': 0.9999531507492065}},
   {'idx': 3,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0008302843198180199,
     'Pathogenic': 0.9991697072982788}},
   {'idx': 4,
    'truth': 0,
    'pred': 1,
    'probs': {'Benign': 0.4263215959072113, 'Pathogenic': 0.5736784338951111}},
   {'idx': 5,
    'truth': 0,
    'pred': 0,
    'probs': {'Benign': 0.6723854541778564,
     'Pathogenic': 0.32761451601982117}},
   {'idx': 6,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0003627222904469818,
     'Pathogenic': 0.999637246131897}},
   {'idx': 7,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0006671537412330508,
     'Pathogenic': 0.9993329048156738}},
   {'idx': 8,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.9005517363548279,
     'Pathogenic': 0.09944834560155869}},
   {'idx': 9,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.000269552314421162,
     'Pathogenic': 0.9997304677963257}}],
  'predictions_path': 'artifacts/qwen3/test_scored.feather',
  'rationales': [{'idx': 27610,
    'pred_label': 'Benign',
    'rationale': 'the variant is located in the splice region but not at the splice donor, acceptor, or intron boundaries and does not disrupt consensus sequences, it is unlikely to affect splicing.'},
   {'idx': 26405,
    'pred_label': 'Benign',
    'rationale': 'this variant is synonymous (C>T in the same codon GgC/ggT), it does not alter the amino acid (Gly) or the protein sequence, and therefore has no impact on the coding sequence.'},
   {'idx': 20675,
    'pred_label': 'Benign',
    'rationale': 'this variant is synonymous (C>G) and does not change the amino acid (L), it has no impact on the protein sequence or function.'},
   {'idx': 16592,
    'pred_label': 'Benign',
    'rationale': 'this variant is a synonymous variant (same amino acid and codon consequence), it does not alter the protein sequence, so its impact is minimal.'},
   {'idx': 8757,
    'pred_label': 'Benign',
    'rationale': 'this variant is a synonymous variant (same amino acid and codon change within the same codon type), it does not alter the amino acids or the protein sequence, thus the consequence is neutral.'},
   {'idx': 1330,
    'pred_label': 'Pathogenic',
    'rationale': 'the variant causes a frameshift with early stop codon, it severely disrupts the protein sequence and is predicted to result in a truncated nonfunctional protein.'},
   {'idx': 536,
    'pred_label': 'Benign',
    'rationale': 'the variant is a missense variant in a protein-coding region with no known severe consequences or phenotype, and the residue is not located in a critical functional domain.'},
   {'idx': 9993,
    'pred_label': 'Pathogenic',
    'rationale': 'this variant is a frameshift variant (impact: High), it will result in a frameshift and a premature stop codon, which disrupts the reading frame and leads to a truncated, nonfunctional protein.'},
   {'idx': 5690,
    'pred_label': 'Benign',
    'rationale': 'the variant affects a downstream gene with no known impact, and no allele-specific consequence is provided, the effect is most likely neutral.'},
   {'idx': 2442,
    'pred_label': 'Benign',
    'rationale': 'this variant is synonymous (Cga/Aga), the amino acid sequence remains unchanged, indicating no effect on the protein product.'}]}}

In [8]: out
Out[8]: 
{'cond_only': {'split': 'val',
  'n': 10000,
  'accuracy': 0.7716,
  'precision': 0.6482021379980564,
  'recall': 0.4609536973047685,
  'f1': 0.5387722132471728,
  'auc_roc': 0.7478824216023097,
  'auc_pr': 0.5885073276065947,
  'confusion_matrix': [[6382, 724], [1560, 1334]],
  'report': '              precision    recall  f1-score   support\n\n      Benign      0.804     0.898     0.848      7106\n  Pathogenic      0.648     0.461     0.539      2894\n\n    accuracy                          0.772     10000\n   macro avg      0.726     0.680     0.693     10000\nweighted avg      0.759     0.772     0.759     10000\n',
  'examples': [{'idx': 0,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.6548947691917419,
     'Pathogenic': 0.34510526061058044}},
   {'idx': 1,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.18240730464458466,
     'Pathogenic': 0.8175926804542542}},
   {'idx': 2,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.6993057131767273, 'Pathogenic': 0.3006942570209503}},
   {'idx': 3,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.26279452443122864,
     'Pathogenic': 0.7372053861618042}},
   {'idx': 4,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.6187227964401245, 'Pathogenic': 0.3812771439552307}},
   {'idx': 5,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.3594765365123749, 'Pathogenic': 0.6405234336853027}},
   {'idx': 6,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.41111084818840027,
     'Pathogenic': 0.5888891220092773}},
   {'idx': 7,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.4073333740234375, 'Pathogenic': 0.5926665663719177}},
   {'idx': 8,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.3702253997325897, 'Pathogenic': 0.6297745704650879}},
   {'idx': 9,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.21215038001537323,
     'Pathogenic': 0.7878495454788208}}],
  'predictions_path': 'artifacts/qwen3/val_scored.feather'},
 'cond+prompt': {'split': 'val',
  'n': 10000,
  'accuracy': 0.9392,
  'precision': 0.8898362892223738,
  'recall': 0.901520387007602,
  'f1': 0.8956402334363199,
  'auc_roc': 0.9826910729439928,
  'auc_pr': 0.9660598511583428,
  'confusion_matrix': [[6783, 323], [285, 2609]],
  'report': '              precision    recall  f1-score   support\n\n      Benign      0.960     0.955     0.957      7106\n  Pathogenic      0.890     0.902     0.896      2894\n\n    accuracy                          0.939     10000\n   macro avg      0.925     0.928     0.926     10000\nweighted avg      0.939     0.939     0.939     10000\n',
  'examples': [{'idx': 0,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.007117005530744791,
     'Pathogenic': 0.9928829669952393}},
   {'idx': 1,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0010661300038918853,
     'Pathogenic': 0.9989338517189026}},
   {'idx': 2,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0034280652180314064,
     'Pathogenic': 0.9965718984603882}},
   {'idx': 3,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0010999543592333794,
     'Pathogenic': 0.9989000558853149}},
   {'idx': 4,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.005740972235798836,
     'Pathogenic': 0.9942589998245239}},
   {'idx': 5,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0020469881128519773,
     'Pathogenic': 0.997952938079834}},
   {'idx': 6,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0015756215434521437,
     'Pathogenic': 0.9984243512153625}},
   {'idx': 7,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.6892010569572449, 'Pathogenic': 0.3107989430427551}},
   {'idx': 8,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.39981159567832947,
     'Pathogenic': 0.6001883745193481}},
   {'idx': 9,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0008838304784148932,
     'Pathogenic': 0.9991162419319153}}],
  'predictions_path': 'artifacts/qwen3/val_scored.feather'},
 'prompt_only': {'split': 'val',
  'n': 10000,
  'accuracy': 0.9265,
  'precision': 0.8728842832469775,
  'recall': 0.8731859018659295,
  'f1': 0.8730350665054414,
  'auc_roc': 0.9763219261840301,
  'auc_pr': 0.9540277779919712,
  'confusion_matrix': [[6738, 368], [367, 2527]],
  'report': '              precision    recall  f1-score   support\n\n      Benign      0.948     0.948     0.948      7106\n  Pathogenic      0.873     0.873     0.873      2894\n\n    accuracy                          0.926     10000\n   macro avg      0.911     0.911     0.911     10000\nweighted avg      0.927     0.926     0.927     10000\n',
  'examples': [{'idx': 0,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0032710933592170477,
     'Pathogenic': 0.9967288970947266}},
   {'idx': 1,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.001170884701423347,
     'Pathogenic': 0.9988291263580322}},
   {'idx': 2,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0012080514570698142,
     'Pathogenic': 0.9987919926643372}},
   {'idx': 3,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0011348582338541746,
     'Pathogenic': 0.9988651871681213}},
   {'idx': 4,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0012080525048077106,
     'Pathogenic': 0.9987919926643372}},
   {'idx': 5,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0014801389770582318,
     'Pathogenic': 0.9985198378562927}},
   {'idx': 6,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0014123583678156137,
     'Pathogenic': 0.9985876083374023}},
   {'idx': 7,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.907332718372345, 'Pathogenic': 0.09266725182533264}},
   {'idx': 8,
    'truth': 1,
    'pred': 0,
    'probs': {'Benign': 0.6187227964401245, 'Pathogenic': 0.3812771439552307}},
   {'idx': 9,
    'truth': 1,
    'pred': 1,
    'probs': {'Benign': 0.0011172642698511481,
     'Pathogenic': 0.9988827109336853}}],
  'predictions_path': 'artifacts/qwen3/val_scored.feather'}}
